@model PBL3.ViewModels.User.IntroViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Trang chủ";
}
@section css {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/css/StyleSheet.css" rel="stylesheet">
    <link href="~/css/dashboard-modern.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
}



<!-- Hero Header -->
<div class="hero-header">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">@Model.HeaderMessage</h1>
            <div class="hero-stats">
                <div class="stat-item">
                    <span class="stat-number">@Model.HotStories?.Count</span>
                    <span class="stat-label">Truyện Hot</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@Model.NewStories?.Count</span>
                    <span class="stat-label">Truyện Mới</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@Model.CompletedStories?.Count</span>
                    <span class="stat-label">Hoàn Thành</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@Model.AllCategories?.Count</span>
                    <span class="stat-label">Thể Loại</span>
                </div>
            </div>
        </div>
    </div>
</div>

<main class="dashboard-main">
    <div class="container-fluid">
        @if (Model.IsAuthenticated)
        {
            <!-- Featured Sections for Authenticated Users -->
            <div class="featured-sections">
                <!-- Top Stories of Week - Special Layout -->
                @if (Model.TopStoriesOfWeek != null && Model.TopStoriesOfWeek.Any())
                {
                    <div class="featured-section top-stories-week" data-aos="fade-up" data-aos-duration="800">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="fas fa-trophy"></i>
                                <h2>Top Tuần</h2>
                                <span class="section-subtitle">Bảng xếp hạng truyện hot nhất tuần</span>
                            </div>
                            <div class="section-action">
                                <a href="#" class="btn-view-all">Xem tất cả <i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                        <div class="top-stories-grid">
                            @for (int i = 0; i < Math.Min(Model.TopStoriesOfWeek.Count, 10); i++)
                            {
                                var story = Model.TopStoriesOfWeek[i];
                                var rankClass = i < 3 ? $"rank-{i + 1}" : "rank-normal";

                                <div class="top-story-item @rankClass" data-rank="@(i + 1)">
                                    <div class="rank-badge">
                                        @if (i < 3)
                                        {
                                            <i class="fas fa-medal"></i>
                                        }
                                        else
                                        {
                                            <span>@(i + 1)</span>
                                        }
                                    </div>
                                    <div class="story-cover">
                                        <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                        <div class="story-overlay">
                                            <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                                <i class="fas fa-book-open"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="story-info">
                                        <h4 class="story-title">@story.Title</h4>
                                        <p class="story-author">@story.AuthorName</p>
                                        <div class="story-stats">
                                            <span><i class="fas fa-eye"></i> @story.ViewCount.ToString("N0")</span>
                                            <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Top Liked Stories - Special Layout -->
                <div class="featured-section top-liked-stories" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="200">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-heart"></i>
                            <h2>Được Yêu Thích Nhất</h2>
                            <span class="section-subtitle">Những truyện có lượt thích cao nhất</span>
                        </div>
                        <div class="section-action">
                            <a href="#" class="btn-view-all">Xem tất cả <i class="fas fa-arrow-right"></i></a>
                        </div>
                    </div>
                    <div class="liked-stories-carousel">
                        @foreach (var story in Model.HotStories.Take(8))
                        {
                            <div class="liked-story-card">
                                <div class="card-inner">
                                    <div class="card-front">
                                        <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                        <div class="like-count">
                                            <i class="fas fa-heart"></i>
                                            <span>@story.ViewCount</span>
                                        </div>

                                    </div>
                                    <div class="card-back">
                                        <h4>@story.Title</h4>
                                        <p>@story.AuthorName</p>
                                        <div class="story-badges">
                                            @if (story.IsHot)
                                            {
                                                <span class="badge badge-hot">Hot</span>
                                            }
                                            @if (story.IsNew)
                                            {
                                                <span class="badge badge-new">New</span>
                                            }
                                            @if (story.IsCompleted)
                                            {
                                                <span class="badge badge-complete">Full</span>
                                            }
                                        </div>
                                        <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read-now">
                                            Đọc ngay
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Top Authors - Circular Layout -->
                @if (Model.FollowedAuthors != null && Model.FollowedAuthors.Any())
                {
                    <div class="featured-section top-authors" data-aos="fade-up" data-aos-duration="1200" data-aos-delay="400">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="fas fa-users"></i>
                                <h2>Tác Giả Nổi Bật</h2>
                                <span class="section-subtitle">Những tác giả được theo dõi nhiều nhất</span>
                            </div>
                            <div class="section-action">
                                <a href="#" class="btn-view-all">Xem tất cả <i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>
                        <div class="authors-circle-grid">
                            @foreach (var author in Model.FollowedAuthors.Take(12))
                            {
                                var tierClass = author.TotalFollowers switch
                                {
                                    >= 5000 => "tier-diamond",
                                    >= 1000 => "tier-gold",
                                    >= 500 => "tier-silver",
                                    >= 100 => "tier-bronze",
                                    _ => "tier-basic"
                                };

                                <div class="author-circle @tierClass">
                                    <div class="author-ring">
                                        <div class="author-avatar">
                                            <img src="@author.Avatar" alt="@author.Name" loading="lazy">
                                        </div>
                                        <div class="follower-count">@author.TotalFollowers</div>
                                    </div>
                                    <div class="author-info">
                                        <h5>@author.Name</h5>
                                        <p>@author.TotalStories truyện</p>
                                    </div>
                                    <div class="author-actions">
                                        <a asp-controller="User" asp-action="ViewProfile" asp-route-id="@author.Id" class="btn-profile">
                                            <i class="fas fa-user"></i>
                                        </a>
                                        <button class="btn-unfollow unfollow-author" data-author-id="@author.Id">
                                            <i class="fas fa-user-minus"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Followed Stories -->
                @if (Model.FollowedStories != null && Model.FollowedStories.Any())
                {
                    <div class="featured-section followed-stories" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="600">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="fas fa-bookmark"></i>
                                <h2>Truyện Đang Theo Dõi</h2>
                                <span class="section-subtitle">Cập nhật mới nhất từ truyện bạn yêu thích</span>
                            </div>
                        </div>
                        <div class="followed-stories-list">
                            @foreach (var story in Model.FollowedStories.Take(6))
                            {
                                <div class="followed-story-item">
                                    <div class="story-thumbnail">
                                        <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                        <div class="update-badge">
                                            <i class="fas fa-clock"></i>
                                            <span>@story.LastUpdated?.ToString("dd/MM")</span>
                                        </div>
                                    </div>
                                    <div class="story-details">
                                        <h4>@story.Title</h4>
                                        <p>@story.AuthorName</p>
                                        @if (story.LatestChapter != null)
                                        {
                                            <div class="latest-chapter">
                                                <i class="fas fa-book-open"></i>
                                                <span>Chương @story.LatestChapter.ChapterNumber</span>
                                            </div>
                                        }
                                        <div class="story-actions">
                                            <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-continue">
                                                Tiếp tục đọc
                                            </a>
                                            <button class="btn-unfollow unfollow-story" data-story-id="@story.Id">
                                                <i class="fas fa-bookmark-slash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Regular Sections -->
        <div class="regular-sections">
            <!-- Hot Stories Grid -->
            <div class="section hot-stories-section" data-aos="fade-right" data-aos-duration="800">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-fire"></i>
                        <h2>Truyện Hot</h2>
                    </div>
                    <div class="section-filters">
                        <select class="form-select" id="categoryFilter" asp-items="@Model.CategorySelectList">
                            <option value="0" selected>Tất cả thể loại</option>
                        </select>
                    </div>
                </div>
                <div class="stories-grid" id="hotStoriesContainer">
                    @foreach (var story in Model.HotStories)
                    {
                        <div class="story-card">
                            <div class="story-image">
                                <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                <div class="story-badges">
                                    @if (story.IsHot)
                                    {
                                        <span class="badge badge-hot">Hot</span>
                                    }
                                    @if (story.IsNew)
                                    {
                                        <span class="badge badge-new">New</span>
                                    }
                                    @if (story.IsCompleted)
                                    {
                                        <span class="badge badge-complete">Full</span>
                                    }
                                </div>
                                <div class="story-overlay">
                                    <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                        <i class="fas fa-book-open"></i>
                                        <span>Đọc ngay</span>
                                    </a>
                                </div>
                            </div>
                            <div class="story-info">
                                <h4>@story.Title</h4>
                                <p>@story.AuthorName</p>
                                <div class="story-stats">
                                    <span><i class="fas fa-eye"></i> @story.ViewCount.ToString("N0")</span>
                                    <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- New Stories List -->
            <div class="section new-stories-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-plus-circle"></i>
                        <h2>Truyện Mới</h2>
                    </div>
                </div>
                <div class="stories-list">
                    @foreach (var story in Model.NewStories)
                    {
                        <div class="story-list-item">
                            <div class="story-rank">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="story-title">
                                <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id">@story.Title</a>
                            </div>
                            <div class="story-meta">
                                <span class="author">@story.AuthorName</span>
                                @if (story.LatestChapter != null)
                                {
                                    <span class="chapter">Chương @story.LatestChapter.ChapterNumber</span>
                                }
                            </div>
                            <div class="story-badges">
                                @if (story.IsNew)
                                {
                                    <span class="badge badge-new">New</span>
                                }
                                @if (story.IsCompleted)
                                {
                                    <span class="badge badge-complete">Full</span>
                                }
                                @if (story.IsHot)
                                {
                                    <span class="badge badge-hot">Hot</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Completed Stories -->
            <div class="section completed-stories-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-check-circle"></i>
                        <h2>Truyện Hoàn Thành</h2>
                    </div>
                </div>
                <div class="completed-stories-grid">
                    @foreach (var story in Model.CompletedStories)
                    {
                        <div class="completed-story-card">
                            <div class="story-image">
                                <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                <div class="completed-badge">
                                    <i class="fas fa-check"></i>
                                    <span>Hoàn thành</span>
                                </div>
                            </div>
                            <div class="story-info">
                                <h4>@story.Title</h4>
                                <p>@story.ChapterCount chương</p>
                                <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read-complete">
                                    Đọc ngay
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="dashboard-sidebar">
            <div class="sidebar-section categories-section">
                <h3><i class="fas fa-tags"></i> Thể Loại</h3>
                <div class="categories-grid">
                    @foreach (var category in Model.AllCategories)
                    {
                        <a asp-controller="Category" asp-action="Details" asp-route-id="@category.Id" class="category-tag">
                            @category.Name
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        $(document).ready(function () {
            // Category filter for hot stories
            $('#categoryFilter').change(function () {
                const categoryId = $(this).val();

                $('#hotStoriesContainer').addClass('loading');

                $.ajax({
                    url: '@Url.Action("GetHotStoriesByCategory", "User")',
                    type: 'GET',
                    data: { categoryId: categoryId },
                    success: function (data) {
                        $('#hotStoriesContainer').html(data).removeClass('loading');
                    },
                    error: function () {
                        $('#hotStoriesContainer').removeClass('loading');
                        toastr.error('Đã xảy ra lỗi khi tải dữ liệu.');
                    }
                });
            });

            // Unfollow story
            $('.unfollow-story').click(function() {
                var storyId = $(this).data('story-id');
                var button = $(this);

                if (confirm('Bạn có chắc chắn muốn bỏ theo dõi truyện này?')) {
                    $.ajax({
                        url: '/Follow/UnfollowStory',
                        type: 'POST',
                        data: { storyId: storyId },
                        success: function(response) {
                            if (response.success) {
                                button.closest('.followed-story-item').fadeOut();
                                toastr.success('Đã bỏ theo dõi truyện');
                            } else {
                                toastr.error(response.message || 'Có lỗi xảy ra');
                            }
                        },
                        error: function() {
                            toastr.error('Có lỗi xảy ra khi bỏ theo dõi');
                        }
                    });
                }
            });

            // Unfollow author
            $('.unfollow-author').click(function() {
                var authorId = $(this).data('author-id');
                var button = $(this);

                if (confirm('Bạn có chắc chắn muốn bỏ theo dõi tác giả này?')) {
                    $.ajax({
                        url: '/Follow/UnfollowUser',
                        type: 'POST',
                        data: { followingId: authorId },
                        success: function(response) {
                            if (response.success) {
                                button.closest('.author-circle').fadeOut();
                                toastr.success('Đã bỏ theo dõi tác giả');
                            } else {
                                toastr.error(response.message || 'Có lỗi xảy ra');
                            }
                        },
                        error: function() {
                            toastr.error('Có lỗi xảy ra khi bỏ theo dõi');
                        }
                    });
                }
            });

            // Initialize animations
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true
            });
        });
    </script>
} 