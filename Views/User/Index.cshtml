@model PBL3.ViewModels.User.IntroViewModel
@{
    ViewData["Title"] = "Trang chủ";
}
@section css {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/css/StyleSheet.css" rel="stylesheet">
    <link href="~/css/dashboard-optimized.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
}

<!-- Hero Header -->
<div class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">@Model.HeaderMessage</h1>
            <div class="hero-stats">
                <div class="stat-item">
                    <span class="stat-number">@Model.Statistics.TotalActiveStories.ToString("N0")</span>
                    <span class="stat-label">Truyện Đang Tiến Hành</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@Model.Statistics.TotalNewStories.ToString("N0")</span>
                    <span class="stat-label">Truyện Mới Tuần</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@Model.Statistics.TotalCompletedStories.ToString("N0")</span>
                    <span class="stat-label">Hoàn Thành</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@Model.Statistics.TotalAuthors.ToString("N0")</span>
                    <span class="stat-label">Tác Giả</span>
                </div>
            </div>
        </div>
    </div>
</div>

<main class="dashboard-main">
    <div class="container-fluid">
        @if (Model.IsAuthenticated)
        {
            <!-- Featured Sections for Authenticated Users -->
            
            <!-- Top Stories of Week Carousel -->
            @if (Model.TopStoriesOfWeek != null && Model.TopStoriesOfWeek.Any())
            {
                <div class="stories-container top-stories" data-aos="fade-up" data-aos-duration="800">
                    <div class="container-header">
                        <div class="container-title-section">
                            <div class="container-title">
                                <i class="fas fa-crown"></i>
                                <h2>Top Truyện Tuần</h2>
                            </div>
                            <div class="container-subtitle">Bảng xếp hạng truyện hot nhất tuần này</div>
                        </div>
                        <a asp-controller="Story" asp-action="AllStories" asp-route-query="topweek" class="btn-view-all">
                            <span>Xem tất cả</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    <div class="stories-slider" data-carousel="top-stories">
                        <div class="stories-track">
                            @for (int i = 0; i < Model.TopStoriesOfWeek.Count; i++)
                            {
                                var story = Model.TopStoriesOfWeek[i];
                                var rankClass = i < 3 ? $"rank-{i + 1}" : "rank-normal";

                                <div class="story-item @rankClass">
                                    <div class="rank-badge">
                                        @if (i < 3)
                                        {
                                            <i class="fas fa-medal"></i>
                                        }
                                        else
                                        {
                                            <span>@(i + 1)</span>
                                        }
                                    </div>
                                    <div class="story-image">
                                        <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                        <div class="story-badges">
                                            @if (story.IsHot)
                                            {
                                                <span class="badge badge-hot">Hot</span>
                                            }
                                            @if (story.IsNew)
                                            {
                                                <span class="badge badge-new">New</span>
                                            }
                                            @if (story.IsCompleted)
                                            {
                                                <span class="badge badge-complete">Full</span>
                                            }
                                        </div>
                                        <div class="story-overlay">
                                            <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                                <i class="fas fa-book-open"></i>
                                                <span>Đọc ngay</span>
                                            </a>
                                        </div>
                                        <div class="view-count">
                                            <i class="fas fa-eye"></i>
                                            <span>@story.ViewCount</span>
                                        </div>
                                    </div>
                                    <div class="story-info">
                                        <h4 class="story-title">@story.Title</h4>
                                        <p class="story-author">@story.AuthorName</p>
                                        <div class="story-stats">
                                            <span><i class="fas fa-eye"></i> @story.ViewCount</span>
                                            <span><i class="fas fa-users"></i> @story.FollowCount</span>
                                            <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <button class="nav-arrow prev" data-direction="prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-arrow next" data-direction="next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            }
            <!-- Hot Stories Carousel -->
            <div class="stories-container hot-stories-section" data-aos="fade-right" data-aos-duration="800">
                <div class="container-header">
                    <div class="container-title-section">
                        <div class="container-title">
                            <i class="fas fa-fire"></i>
                            <h2>Truyện Hot</h2>
                        </div>
                        <div class="container-subtitle">Những truyện được yêu thích nhất</div>
                    </div>
                    <a asp-controller="Story" asp-action="AllStories" asp-route-query="view" class="btn-view-all">
                        <span>Xem tất cả</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="filter-section">
                    <label for="categoryFilter">Lọc theo thể loại:</label>
                    <select class="form-select" id="categoryFilter" asp-items="@Model.CategorySelectList">
                        <option value="0" selected>Tất cả thể loại</option>
                    </select>
                </div>
                <div class="stories-slider" data-carousel="hot-stories">
                    <div class="stories-track" id="hotStoriesContainer">
                        @foreach (var story in Model.HotStories)
                        {
                            <div class="story-item">
                                <div class="story-image">
                                    <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                    <div class="story-badges">
                                        @if (story.IsHot)
                                        {
                                            <span class="badge badge-hot">Hot</span>
                                        }
                                        @if (story.IsNew)
                                        {
                                            <span class="badge badge-new">New</span>
                                        }
                                        @if (story.IsCompleted)
                                        {
                                            <span class="badge badge-complete">Full</span>
                                        }
                                    </div>
                                    <div class="story-overlay">
                                        <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                            <i class="fas fa-book-open"></i>
                                            <span>Đọc ngay</span>
                                        </a>
                                    </div>
                                    <div class="view-count">
                                        <i class="fas fa-eye"></i>
                                        <span>@story.ViewCount</span>
                                    </div>
                                </div>
                                <div class="story-info">
                                    <h4 class="story-title">@story.Title</h4>
                                    <p class="story-author">@story.AuthorName</p>
                                    <div class="story-stats">
                                        <span><i class="fas fa-eye"></i> @story.ViewCount</span>
                                        <span><i class="fas fa-users"></i> @story.FollowCount</span>
                                        <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <button class="nav-arrow prev" data-direction="prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-arrow next" data-direction="next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <!-- New Stories Carousel -->
            <div class="stories-container new-stories-section" data-aos="fade-left" data-aos-duration="800">
                <div class="container-header">
                    <div class="container-title-section">
                        <div class="container-title">
                            <i class="fas fa-sparkles"></i>
                            <h2>Truyện Mới</h2>
                        </div>
                        <div class="container-subtitle">Những câu chuyện vừa mới ra mắt</div>
                    </div>
                    <a asp-controller="Story" asp-action="AllStories" asp-route-query="updated" class="btn-view-all">
                        <span>Xem tất cả</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="stories-slider" data-carousel="new-stories">
                    <div class="stories-track">
                        @foreach (var story in Model.NewStories)
                        {
                            <div class="story-item new-story-item">
                                <div class="story-image">
                                    <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                    <div class="story-badges">
                                        @if (story.IsNew)
                                        {
                                            <span class="badge badge-new">New</span>
                                        }
                                        @if (story.IsCompleted)
                                        {
                                            <span class="badge badge-complete">Full</span>
                                        }
                                        @if (story.IsHot)
                                        {
                                            <span class="badge badge-hot">Hot</span>
                                        }
                                    </div>
                                    <div class="story-overlay">
                                        <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                            <i class="fas fa-book-open"></i>
                                            <span>Đọc ngay</span>
                                        </a>
                                    </div>
                                    @if (story.LatestChapter != null)
                                    {
                                        <div class="view-count">
                                            <i class="fas fa-book-open"></i>
                                            <span>Ch. @story.LatestChapter.ChapterNumber</span>
                                        </div>
                                    }
                                </div>
                                <div class="story-info">
                                    <h4 class="story-title">@story.Title</h4>
                                    <p class="story-author">@story.AuthorName</p>
                                    <div class="story-stats">
                                        <span><i class="fas fa-eye"></i> @story.ViewCount</span>
                                        <span><i class="fas fa-users"></i> @story.FollowCount</span>
                                        <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <button class="nav-arrow prev" data-direction="prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-arrow next" data-direction="next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Top Liked Stories Carousel -->
            <div class="stories-container liked-stories" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="200">
                <div class="container-header">
                    <div class="container-title-section">
                        <div class="container-title">
                            <i class="fas fa-heart"></i>
                            <h2>Được Yêu Thích Nhất</h2>
                        </div>
                        <div class="container-subtitle">Những truyện có lượt thích cao nhất</div>
                    </div>
                    <a asp-controller="Story" asp-action="AllStories" asp-route-query="like" class="btn-view-all">
                        <span>Xem tất cả</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="stories-slider" data-carousel="liked-stories">
                    <div class="stories-track">
                        @foreach (var story in Model.MostLikedStories)
                        {
                            <div class="story-item">
                                <div class="story-image">
                                    <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                    <div class="story-badges">
                                        @if (story.IsHot)
                                        {
                                            <span class="badge badge-hot">Hot</span>
                                        }
                                        @if (story.IsNew)
                                        {
                                            <span class="badge badge-new">New</span>
                                        }
                                        @if (story.IsCompleted)
                                        {
                                            <span class="badge badge-complete">Full</span>
                                        }
                                    </div>
                                    <div class="story-overlay">
                                        <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                            <i class="fas fa-book-open"></i>
                                            <span>Đọc ngay</span>
                                        </a>
                                    </div>
                                    <div class="view-count">
                                        <i class="fas fa-heart"></i>
                                        <span>@story.LikeCount</span>
                                    </div>
                                </div>
                                <div class="story-info">
                                    <h4 class="story-title">@story.Title</h4>
                                    <p class="story-author">@story.AuthorName</p>
                                    <div class="story-stats">
                                        <span><i class="fas fa-heart"></i> @story.LikeCount</span>
                                        <span><i class="fas fa-eye"></i> @story.ViewCount</span>
                                        <span><i class="fas fa-users"></i> @story.FollowCount</span>
                                        <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <button class="nav-arrow prev" data-direction="prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-arrow next" data-direction="next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Top Followed Stories Carousel -->
            @if (Model.TopFollowedStories != null && Model.TopFollowedStories.Any())
            {
                <div class="stories-container top-followed-stories" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="600">
                    <div class="container-header">
                        <div class="container-title-section">
                            <div class="container-title">
                                <i class="fas fa-users"></i>
                                <h2>Top Truyện Được Theo Dõi</h2>
                            </div>
                            <div class="container-subtitle">Những truyện được theo dõi nhiều nhất</div>
                        </div>
                        <a asp-controller="Story" asp-action="AllStories" asp-route-query="follow" class="btn-view-all">
                            <span>Xem tất cả</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    <div class="stories-slider" data-carousel="top-followed-stories">
                        <div class="stories-track">
                            @foreach (var story in Model.TopFollowedStories)
                            {
                                <div class="story-item top-followed-item">
                                    <div class="story-image">
                                        <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                        <div class="story-badges">
                                            @if (story.IsHot)
                                            {
                                                <span class="badge badge-hot">Hot</span>
                                            }
                                            @if (story.IsNew)
                                            {
                                                <span class="badge badge-new">New</span>
                                            }
                                            @if (story.IsCompleted)
                                            {
                                                <span class="badge badge-complete">Full</span>
                                            }
                                        </div>
                                        <div class="story-overlay">
                                            <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                                <i class="fas fa-book-open"></i>
                                                <span>Đọc ngay</span>
                                            </a>
                                        </div>
                                        <div class="view-count">
                                            <i class="fas fa-users"></i>
                                            <span>@story.FollowCount</span>
                                        </div>
                                    </div>
                                    <div class="story-info">
                                        <h4 class="story-title">@story.Title</h4>
                                        <p class="story-author">@story.AuthorName</p>
                                        <div class="story-stats">
                                            <span><i class="fas fa-users"></i> @story.FollowCount</span>
                                            <span><i class="fas fa-eye"></i> @story.ViewCount</span>
                                            <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <button class="nav-arrow prev" data-direction="prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-arrow next" data-direction="next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            }
        }
            <!-- Recent Reading History -->
            @if (Model.IsAuthenticated && Model.RecentlyRead != null && Model.RecentlyRead.Any())
            {
                <div class="stories-container recent-reads" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="500">
            <div class="container-header">
                <div class="container-title-section">
                    <div class="container-title">
                                <i class="fas fa-history"></i>
                                <h2>Đọc Gần Đây</h2>
                            </div>
                            <div class="container-subtitle">Tiếp tục hành trình đọc truyện của bạn</div>
                        </div>
                        <a asp-controller="User" asp-action="History" class="btn-view-all">
                            <span>Xem tất cả</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    <div class="stories-slider" data-carousel="recent-reads">
                        <div class="stories-track">
                            @foreach (var read in Model.RecentlyRead)
                            {
                                <div class="story-item recent-read-item">
                                    <div class="story-image">
                                        <img src="@read.CoverImage" alt="@read.StoryTitle" loading="lazy">
                                        <div class="progress-overlay">
                                            <div class="progress-bar" style="width: @read.ReadProgress%"></div>
                                            <span class="progress-text">@read.ReadProgress%</span>
                                        </div>
                                                                <div class="story-overlay">
                            <a asp-controller="Chapter" asp-action="ReadChapter" asp-route-id="@read.ChapterID" class="btn-read">
                                <i class="fas fa-play"></i>
                                <span>Tiếp tục đọc</span>
                            </a>
                        </div>
                                    </div>
                                    <div class="story-info">
                                        <h4 class="story-title">@read.StoryTitle</h4>
                                        <p class="story-author">Chương @read.ChapterID: @read.ChapterTitle</p>
                                        <div class="story-stats">
                                            <span><i class="fas fa-clock"></i> @read.LastRead.ToString("dd/MM/yyyy")</span>
                                            <span><i class="fas fa-book"></i> @read.TotalChapters chương</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <button class="nav-arrow prev" data-direction="prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-arrow next" data-direction="next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            }

            <!-- Following Stories -->
            @if (Model.IsAuthenticated && Model.FollowingStories != null && Model.FollowingStories.Any())
            {
                <div class="stories-container following-stories" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="600">
                    <div class="container-header">
                        <div class="container-title-section">
                            <div class="container-title">
                                <i class="fas fa-rss"></i>
                                <h2>Truyện Từ Tác Giả Theo Dõi</h2>
                            </div>
                            <div class="container-subtitle">Cập nhật mới nhất từ các tác giả bạn yêu thích</div>
                        </div>
                        <a asp-controller="User" asp-action="Following" class="btn-view-all">
                    <span>Xem tất cả</span>
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
                    <div class="stories-slider" data-carousel="following-stories">
                        <div class="stories-track">
                            @foreach (var story in Model.FollowingStories)
                    {
                                <div class="story-item following-story-item">
                            <div class="story-image">
                                <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                <div class="story-badges">
                                    @if (story.IsHot)
                                    {
                                        <span class="badge badge-hot">Hot</span>
                                    }
                                    @if (story.IsNew)
                                    {
                                        <span class="badge badge-new">New</span>
                                    }
                                    @if (story.IsCompleted)
                                    {
                                        <span class="badge badge-complete">Full</span>
                                    }
                                </div>
                                <div class="story-overlay">
                                    <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                        <i class="fas fa-book-open"></i>
                                        <span>Đọc ngay</span>
                                    </a>
                                </div>
                                <div class="view-count">
                                    <i class="fas fa-eye"></i>
                                            <span>@story.ViewCount</span>
                                </div>
                            </div>
                            <div class="story-info">
                                <h4 class="story-title">@story.Title</h4>
                                <p class="story-author">@story.AuthorName</p>
                                <div class="story-stats">
                                            <span><i class="fas fa-users"></i> @story.FollowCount</span>
                                    <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <button class="nav-arrow prev" data-direction="prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-arrow next" data-direction="next">
                    <i class="fas fa-chevron-right"></i>
                </button>
                            </div>
                        </div>
                    }

        <!-- Completed Stories Carousel -->
        <div class="stories-container completed-stories-section" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="200">
            <div class="container-header">
                <div class="container-title-section">
                    <div class="container-title">
                        <i class="fas fa-check-circle"></i>
                        <h2>Truyện Đã Hoàn Thành</h2>
                    </div>
                    <div class="container-subtitle">Những câu chuyện đã có kết thúc hoàn chỉnh</div>
                </div>
                <a asp-controller="Story" asp-action="AllStories" asp-route-query="completed" class="btn-view-all">
                    <span>Xem tất cả</span>
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            <div class="stories-slider" data-carousel="completed-stories">
                <div class="stories-track">
                    @foreach (var story in Model.CompletedStories)
                    {
                        <div class="story-item completed-story-item">
                            <div class="story-image">
                                <img src="@story.CoverImageUrl" alt="@story.Title" loading="lazy">
                                <div class="story-badges">
                                    <span class="badge badge-complete">Hoàn thành</span>
                                </div>
                                <div class="story-overlay">
                                    <a asp-controller="Story" asp-action="View" asp-route-id="@story.Id" class="btn-read">
                                        <i class="fas fa-book-open"></i>
                                        <span>Đọc ngay</span>
                                    </a>
                                </div>
                                <div class="view-count">
                                    <i class="fas fa-check"></i>
                                    <span>@story.ChapterCount ch</span>
                                </div>
                            </div>
                            <div class="story-info">
                                <h4 class="story-title">@story.Title</h4>
                                <p class="story-author">@story.AuthorName</p>
                                <div class="story-stats">
                                    <span><i class="fas fa-eye"></i> @story.ViewCount</span>
                                    <span><i class="fas fa-users"></i> @story.FollowCount</span>
                                    <span><i class="fas fa-book"></i> @story.ChapterCount</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <button class="nav-arrow prev" data-direction="prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-arrow next" data-direction="next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Top Authors Carousel -->
        @if (Model.FollowedAuthors != null && Model.FollowedAuthors.Any())
        {
            <div class="stories-container authors-carousel" data-aos="fade-up" data-aos-duration="1200" data-aos-delay="400">
                <div class="container-header">
                    <div class="container-title-section">
                        <div class="container-title">
                            <i class="fas fa-users"></i>
                            <h2>Tác Giả Nổi Bật</h2>
                        </div>
                        <div class="container-subtitle">Những tác giả được theo dõi nhiều nhất</div>
                    </div>
                    <a asp-controller="Discovery" asp-action="FollowedAuthors" class="btn-view-all">
                        <span>Xem tất cả</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="stories-slider" data-carousel="authors">
                    <div class="stories-track">
                        @foreach (var author in Model.FollowedAuthors)
                        {
                            var tierClass = author.TotalFollowers switch
                            {
                                >= 5000 => "tier-diamond",
                                >= 1000 => "tier-gold",
                                >= 500 => "tier-silver",
                                >= 100 => "tier-bronze",
                                _ => "tier-basic"
                            };

                            <div class="story-item author-item @tierClass">
                                <div class="story-image">
                                    <img src="@author.Avatar" alt="@author.Name" loading="lazy">
                                    <div class="story-overlay">
                                        <a asp-controller="User" asp-action="ViewProfile" asp-route-id="@author.Id" class="btn-read">
                                            <i class="fas fa-user"></i>
                                            <span>Xem Profile</span>
                                        </a>
                                    </div>
                                    <div class="view-count">
                                        <i class="fas fa-users"></i>
                                        <span>@author.TotalFollowers</span>
                                    </div>
                                </div>
                                <div class="story-info">
                                    <h4 class="story-title">@author.Name</h4>
                                    <p class="story-author">@author.TotalStories truyện</p>
                                    <div class="story-stats">
                                        <span><i class="fas fa-users"></i> @author.TotalFollowers</span>
                                        <span><i class="fas fa-book"></i> @author.TotalStories</span>
                                    </div>
                                </div>
                            </div>
                }
                    </div>
                    <button class="nav-arrow prev" data-direction="prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-arrow next" data-direction="next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        }

    </div>
</main>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Carousel Configuration
        const carouselConfig = {
            'top-stories': { itemWidth: 260, visibleItems: { desktop: 5, tablet: 3, mobile: 2 } },
            'liked-stories': { itemWidth: 280, visibleItems: { desktop: 4, tablet: 3, mobile: 2 } },
            'authors': { itemWidth: 240, visibleItems: { desktop: 6, tablet: 4, mobile: 3 } },
            'recent-reads': { itemWidth: 300, visibleItems: { desktop: 4, tablet: 3, mobile: 2 } },
            'following-stories': { itemWidth: 280, visibleItems: { desktop: 4, tablet: 3, mobile: 2 } },
            'recommended-stories': { itemWidth: 280, visibleItems: { desktop: 4, tablet: 3, mobile: 2 } },
            'top-followed-stories': { itemWidth: 320, visibleItems: { desktop: 3, tablet: 2, mobile: 1 } },
            'hot-stories': { itemWidth: 280, visibleItems: { desktop: 4, tablet: 3, mobile: 2 } },
            'new-stories': { itemWidth: 300, visibleItems: { desktop: 4, tablet: 2, mobile: 2 } },
            'completed-stories': { itemWidth: 260, visibleItems: { desktop: 4, tablet: 3, mobile: 2 } }
        };

        // Initialize Carousel Function
        function initCarousel(slider, carouselType) {
            const track = slider.querySelector('.stories-track');
            const prevBtn = slider.querySelector('.nav-arrow.prev');
            const nextBtn = slider.querySelector('.nav-arrow.next');
            const items = track.querySelectorAll('.story-item');
            
            if (!track || !prevBtn || !nextBtn || items.length === 0) return;

            const config = carouselConfig[carouselType] || carouselConfig['hot-stories'];
            let currentIndex = 0;
            let visibleItems = getVisibleItems(config);
            let itemWidth = config.itemWidth;

            function getVisibleItems(config) {
                const width = window.innerWidth;
                if (width >= 1200) return config.visibleItems.desktop;
                if (width >= 768) return config.visibleItems.tablet;
                return config.visibleItems.mobile;
            }

            function updateCarousel() {
                const translateX = -(currentIndex * (itemWidth + 24)); // 24px for gap
                track.style.transform = `translateX(${translateX}px)`;
                
                // Update button states
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex >= items.length - visibleItems;
                
                if (prevBtn.disabled) {
                    prevBtn.classList.add('disabled');
                } else {
                    prevBtn.classList.remove('disabled');
                }
                
                if (nextBtn.disabled) {
                    nextBtn.classList.add('disabled');
                } else {
                    nextBtn.classList.remove('disabled');
                }
            }

            function moveToNext() {
                if (currentIndex < items.length - visibleItems) {
                    currentIndex++;
                    updateCarousel();
                }
            }

            function moveToPrev() {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateCarousel();
                }
            }

            function handleResize() {
                visibleItems = getVisibleItems(config);
                currentIndex = Math.min(currentIndex, Math.max(0, items.length - visibleItems));
                updateCarousel();
            }

            // Event listeners
            nextBtn.addEventListener('click', moveToNext);
            prevBtn.addEventListener('click', moveToPrev);
            window.addEventListener('resize', handleResize);

            // Initialize
            updateCarousel();

            // Return cleanup function
            return () => {
                nextBtn.removeEventListener('click', moveToNext);
                prevBtn.removeEventListener('click', moveToPrev);
                window.removeEventListener('resize', handleResize);
            };
        }

        $(document).ready(function () {
            // Initialize all carousels
            const carousels = document.querySelectorAll('[data-carousel]');
            const cleanupFunctions = [];

            carousels.forEach(carousel => {
                const carouselType = carousel.getAttribute('data-carousel');
                const cleanup = initCarousel(carousel, carouselType);
                if (cleanup) cleanupFunctions.push(cleanup);
            });

            // Category filter for hot stories
            $('#categoryFilter').change(function () {
                const categoryId = $(this).val();
                const hotStoriesContainer = $('#hotStoriesContainer');
                const hotStoriesSlider = hotStoriesContainer.closest('[data-carousel="hot-stories"]');

                hotStoriesContainer.addClass('loading');

                $.ajax({
                    url: '@Url.Action("GetHotStoriesByCategory", "User")',
                    type: 'GET',
                    data: { categoryId: categoryId },
                    success: function (data) {
                        hotStoriesContainer.html(data).removeClass('loading');
                        
                        // Reinitialize hot stories carousel
                        const cleanup = initCarousel(hotStoriesSlider, 'hot-stories');
                        if (cleanup) {
                            // Remove old cleanup and add new one
                            cleanupFunctions.push(cleanup);
                        }
                    },
                    error: function () {
                        hotStoriesContainer.removeClass('loading');
                        toastr.error('Đã xảy ra lỗi khi tải dữ liệu.');
                    }
                });
            });

            // Unfollow author
            $('.unfollow-author').click(function() {
                var authorId = $(this).data('author-id');
                var button = $(this);

                if (confirm('Bạn có chắc chắn muốn bỏ theo dõi tác giả này?')) {
                    $.ajax({
                        url: '/Follow/UnfollowUser',
                        type: 'POST',
                        data: { followingId: authorId },
                        success: function(response) {
                            if (response.success) {
                                const authorItem = button.closest('.story-item');
                                authorItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                authorItem.style.opacity = '0';
                                authorItem.style.transform = 'scale(0.8)';
                                
                                setTimeout(() => {
                                    authorItem.remove();
                                    
                                    // Reinitialize carousel after item removal
                                    const carousel = button.closest('[data-carousel]');
                                    if (carousel) {
                                        const carouselType = carousel.getAttribute('data-carousel');
                                        initCarousel(carousel, carouselType);
                                    }
                                }, 300);
                                
                                toastr.success('Đã bỏ theo dõi tác giả');
                            } else {
                                toastr.error(response.message || 'Có lỗi xảy ra');
                            }
                        },
                        error: function() {
                            toastr.error('Có lỗi xảy ra khi bỏ theo dõi');
                        }
                    });
                }
            });

            // Initialize animations
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true
            });

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                cleanupFunctions.forEach(cleanup => cleanup());
            });
        });
    </script>
}

@*
    ===============================================================================
    DEVELOPER NOTE: ViewModel Architecture Update
    ===============================================================================
    
    This view uses the comprehensive IntroViewModel that supports both guest and 
    authenticated user experiences. The IntroViewModel includes:
    
    ✅ CURRENT IMPLEMENTATION:
    - Basic story collections (Hot, New, Completed, Most Liked)
    - Top Stories of Week with ranking system
    - Top Followed Stories and Authors
    - Personalized content for authenticated users:
      * Recent reading history with progress tracking
      * Stories from followed authors
      * AI-powered recommendations
      * User activity statistics
    
    🔧 TECHNICAL DETAILS:
    - Uses StoryViewModel for consistency across all story displays
    - DashboardService provides comprehensive data population
    - Supports both guest browsing and personalized user experience
    - All carousels use unified JavaScript configuration
    
    📊 DATA SOURCES:
    - DashboardService.GetDashboardDataAsync() - Main data provider
    - StoryRankingService - For recommendations and rankings
    - HistoryService - For reading progress and stats
    - FollowService - For social features
    
    🎨 UI FEATURES:
    - Responsive carousel system with mobile support
    - Progress indicators for reading history
    - Ranking badges for top stories
    - Category filtering for hot stories
    - Lazy loading for optimal performance
    
    ===============================================================================
*@