@model PBL3.ViewModels.Moderator.ViewStoryViewModel
@{
    ViewData["Title"] = "Chi ti·∫øt truy·ªán";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}
<link rel="stylesheet" href="~/css/ViewStory.css" />
<div class="view-story-container">
    <!-- Section 1: Th√¥ng tin truy·ªán -->
    <section class="section-card story-header-section mb-4">
        <img src="@(Model.StoryDetails.CoverImage ?? Url.Content("~/image/default-cover.png"))" class="story-cover-img" alt="Cover" />
        <div class="story-info-block">
            <div class="story-title">@Model.StoryDetails.Title</div>
            <div class="story-badges mb-2">
                <span class="badge bg-@GetStatusColor(Model.StoryDetails.Status)">@Model.StoryDetails.Status</span>
                @if (Model.StoryDetails.isReported)
                {
                    <span class="badge bg-danger ms-2">B·ªã b√°o c√°o</span>
                }
                @if (Model.StoryDetails.Status == PBL3.Models.StoryModel.StoryStatus.Active)
                {
                    <form asp-action="Lock" asp-controller="Story" method="post" class="d-inline ms-2" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√≥a truy·ªán n√†y?');">
                        <input type="hidden" name="storyID" value="@Model.StoryDetails.StoryID" />
                        <input type="hidden" name="message" value="Kh√≥a truy·ªán b·ªüi qu·∫£n tr·ªã vi√™n." />
                        <button type="submit" class="btn btn-sm btn-danger">üîí Kh√≥a truy·ªán</button>
                    </form>
                    
                }
                else if (Model.StoryDetails.Status == PBL3.Models.StoryModel.StoryStatus.ReviewPending)
                {
                    <form asp-action="Unlock" asp-controller="Story" method="post" class="d-inline ms-2" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü kh√≥a v√† duy·ªát truy·ªán n√†y?');">
                        <input type="hidden" name="storyID" value="@Model.StoryDetails.StoryID" />
                        <input type="hidden" name="isAccepted" value="true" />
                        <input type="hidden" name="message" value="Truy·ªán ƒë√£ ƒë∆∞·ª£c duy·ªát v√† m·ªü kh√≥a." />
                        <button type="submit" class="btn btn-sm btn-success">‚úîÔ∏è Duy·ªát &amp; M·ªü kh√≥a</button>
                    </form>
                    <form asp-action="Unlock" asp-controller="Story" method="post" class="d-inline ms-2" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª´ ch·ªëi truy·ªán n√†y?');">
                        <input type="hidden" name="storyID" value="@Model.StoryDetails.StoryID" />
                        <input type="hidden" name="isAccepted" value="false" />
                        <input type="hidden" name="message" value="Y√™u c√¢u duy·ªát truy·ªán ƒë√£ b·ªã t·ª´ ch·ªëi." />
                        <button type="submit" class="btn btn-sm btn-danger">‚ùå T·ª´ ch·ªëi</button>
                    </form>
                }
                @if (User.IsInRole("Admin"))
                {
                    <form asp-action="DeleteStory" asp-controller="Admin" method="post" class="d-inline ms-2" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a truy·ªán n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="StoryID" value="@Model.StoryDetails.StoryID" />
                        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è X√≥a truy·ªán</button>
                    </form>
                }
            </div>
            <div class="story-meta"><strong>T√°c gi·∫£:</strong> <a href="@Url.Action("ViewUser", "Moderator", new { id = Model.Author.UserID })">@Model.Author.DisplayName</a> (ID: @Model.Author.UserID, Email: @Model.Author.Email)</div>
            <div class="story-meta"><strong>Ng√†y t·∫°o:</strong> @Model.StoryDetails.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="story-meta"><strong>C·∫≠p nh·∫≠t:</strong> @Model.StoryDetails.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="story-description"><strong>M√¥ t·∫£:</strong> <span class="text-muted">@Model.StoryDetails.Description</span></div>
            <div class="story-meta"><strong>ID truy·ªán:</strong> @Model.StoryDetails.StoryID</div>
            <div class="story-meta"><strong>S·ªë ch∆∞∆°ng:</strong> @Model.Chapters.Count</div>
            <div class="story-meta"><strong>Tr·∫°ng th√°i t√°c gi·∫£:</strong> <span class="badge bg-@(Model.Author.Status == PBL3.Models.UserModel.UserStatus.Active ? "success" : "secondary")">@Model.Author.Status</span></div>
        </div>
    </section>
    <!-- Section 2: Danh s√°ch ch∆∞∆°ng -->
    <section class="section-card mb-4">
        <div class="card-header"><h5 class="mb-0">Danh s√°ch ch∆∞∆°ng</h5></div>
        <div class="card-body p-0">
            @if (Model.Chapters.Any())
            {
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>L∆∞·ª£t xem</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model.Chapters)
                        {
                            <tr>
                                <td>@c.ChapterOrder</td>
                                <td>@c.Title</td>
                                <td>@c.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@c.ViewCount</td>
                                <td>
                                    <span class="badge bg-@GetChapterStatusColor(c.Status)">@c.Status</span>
                                    @if (c.isReported)
                                    {
                                        <span class="badge bg-danger ms-1">B·ªã b√°o c√°o</span>
                                    }
                                </td>
                                <td>
                                    <a href="@Url.Action("ReadChapter", "Chapter", new { id = c.ChapterID })" class="btn btn-outline-primary btn-sm" target="_blank">Xem</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="text-muted p-3">Ch∆∞a c√≥ ch∆∞∆°ng n√†o.</div>
            }
        </div>
    </section>
    <!-- Section 3: Th√¥ng tin t√°c gi·∫£ -->
    <section class="section-card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Th√¥ng tin t√°c gi·∫£</h5>
            <a href="@Url.Action("ViewUser", "Moderator", new { id = Model.Author.UserID })" class="text-secondary ms-2" title="Xem chi ti·∫øt ng∆∞·ªùi d√πng">
                <i class="bi bi-gear-fill" style="font-size:1.3rem;"></i>
            </a>
        </div>
        <div class="card-body d-flex align-items-center">
            <img src="@(Model.Author.Avatar ?? Url.Content("~/image/default-avatar.png"))" class="rounded-circle me-4" style="width:80px;height:80px;object-fit:cover;border:2px solid #e3e8ee;box-shadow:0 2px 8px rgba(0,0,0,0.07);" alt="Avatar" />
            <div>
                <div class="mb-1"><strong>ID:</strong> <span class="text-primary">@Model.Author.UserID</span></div>
                <div class="mb-1"><strong>T√™n hi·ªÉn th·ªã:</strong> @Model.Author.DisplayName</div>
                <div class="mb-1"><strong>Email:</strong> <span class="text-muted">@Model.Author.Email</span></div>
                <div class="mb-1"><strong>Vai tr√≤:</strong> <span class="badge bg-primary">@Model.Author.Role</span></div>
                <div class="mb-1"><strong>Ng√†y t·∫°o:</strong> @Model.Author.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                <div class="mb-1"><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-@(Model.Author.Status == PBL3.Models.UserModel.UserStatus.Active ? "success" : "secondary")">@Model.Author.Status</span></div>
            </div>
        </div>
    </section>
</div>
@section Styles {
    <link rel="stylesheet" href="~/css/ViewStory.css" />
}
@section Scripts {
    <script src="~/js/ViewStory.js"></script>
}
@functions {
    private string GetStatusColor(PBL3.Models.StoryModel.StoryStatus status)
    {
        return status switch
        {
            PBL3.Models.StoryModel.StoryStatus.Active => "success",
            PBL3.Models.StoryModel.StoryStatus.Completed => "primary",
            PBL3.Models.StoryModel.StoryStatus.Locked => "danger",
            PBL3.Models.StoryModel.StoryStatus.ReviewPending => "warning text-dark",
            _ => "secondary"
        };
    }
    private string GetChapterStatusColor(PBL3.Models.ChapterStatus status)
    {
        return status switch
        {
            PBL3.Models.ChapterStatus.Active => "success",
            PBL3.Models.ChapterStatus.Locked => "danger",
            _ => "secondary"
        };
    }
}
