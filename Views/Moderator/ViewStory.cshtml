@model PBL3.ViewModels.Moderator.ViewStoryViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Story Details"];
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/ViewStory.css" />
<div class="view-story-container mt-5">
    <!-- Section 1: Th√¥ng tin truy·ªán -->
    <section class="section-card story-header-section mb-4">
        <img src="@(Model.StoryDetails.CoverImage ?? Url.Content("~/image/default-cover.png"))" class="story-cover-img" alt="@Localizer["Cover"]" />
        <div class="story-info-block">
            <div class="story-title">@Model.StoryDetails.Title</div>
            <div class="story-badges mb-2">
                <span class="badge bg-@GetStatusColor(Model.StoryDetails.Status)">@Model.StoryDetails.Status</span>
                @if (Model.StoryDetails.isReported)
                {
                    <span class="badge bg-danger ms-2">@Localizer["Reported"]</span>
                }
                @if (Model.StoryDetails.Status == PBL3.Models.StoryModel.StoryStatus.Active)
                {
                    <form asp-action="Lock" asp-controller="Story" method="post" class="d-inline ms-2" onsubmit="return confirm('@Localizer["Lock Confirmation"]');">
                        <input type="hidden" name="storyID" value="@Model.StoryDetails.StoryID" />
                        <input type="hidden" name="message" value="@Localizer["Lock Message"]" />
                        <button type="submit" class="btn btn-sm btn-danger">üîí @Localizer["Lock Story"]</button>
                    </form>
                    
                }
                else if (Model.StoryDetails.Status == PBL3.Models.StoryModel.StoryStatus.ReviewPending)
                {
                    <form asp-action="Unlock" asp-controller="Story" method="post" class="d-inline ms-2" onsubmit="return confirm('@Localizer["Approve Confirmation"]');">
                        <input type="hidden" name="storyID" value="@Model.StoryDetails.StoryID" />
                        <input type="hidden" name="isAccepted" value="true" />
                        <input type="hidden" name="message" value="@Localizer["Approve Message"]" />
                        <button type="submit" class="btn btn-sm btn-success">‚úîÔ∏è @Localizer["Approve & Unlock"]</button>
                    </form>
                    <form asp-action="Unlock" asp-controller="Story" method="post" class="d-inline ms-2" onsubmit="return confirm('@Localizer["Reject Confirmation"]');">
                        <input type="hidden" name="storyID" value="@Model.StoryDetails.StoryID" />
                        <input type="hidden" name="isAccepted" value="false" />
                        <input type="hidden" name="message" value="@Localizer["Reject Message"]" />
                        <button type="submit" class="btn btn-sm btn-danger">‚ùå @Localizer["Reject"]</button>
                    </form>
                }
                @if (User.IsInRole("Admin"))
                {
                    <form asp-action="DeleteStory" asp-controller="Admin" method="post" class="d-inline ms-2" onsubmit="return confirm('@Localizer["Delete Confirmation"]');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="StoryID" value="@Model.StoryDetails.StoryID" />
                        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è @Localizer["Delete Story"]</button>
                    </form>
                }
            </div>
            <div class="story-meta"><strong>@Localizer["Author:"]</strong> <a href="@Url.Action("ViewUser", "Moderator", new { id = Model.Author.UserID })">@Model.Author.DisplayName</a> (ID: @Model.Author.UserID, Email: @Model.Author.Email)</div>
            <div class="story-meta"><strong>@Localizer["Created:"]</strong> @Model.StoryDetails.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="story-meta"><strong>@Localizer["Updated:"]</strong> @Model.StoryDetails.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="story-description"><strong>@Localizer["Description:"]</strong> <span class="text-muted">@Model.StoryDetails.Description</span></div>
            <div class="story-meta"><strong>@Localizer["Story ID:"]</strong> @Model.StoryDetails.StoryID</div>
            <div class="story-meta"><strong>@Localizer["Chapters Count:"]</strong> @Model.Chapters.Count</div>
            <div class="story-meta"><strong>@Localizer["Author Status:"]</strong> <span class="badge bg-@(Model.Author.Status == PBL3.Models.UserModel.UserStatus.Active ? "success" : "secondary")">@Model.Author.Status</span></div>
        </div>
    </section>
    <!-- Section 2: Danh s√°ch ch∆∞∆°ng -->
    <section class="section-card mb-4">
        <div class="card-header"><h5 class="mb-0">@Localizer["Chapters List"]</h5></div>
        <div class="card-body p-0">
            @if (Model.Chapters.Any())
            {
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>@Localizer["#"]</th>
                            <th>@Localizer["Title"]</th>
                            <th>@Localizer["Created At"]</th>
                            <th>@Localizer["Views"]</th>
                            <th>@Localizer["Status"]</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model.Chapters)
                        {
                            <tr>
                                <td>@c.ChapterOrder</td>
                                <td>@c.Title</td>
                                <td>@c.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@c.ViewCount</td>
                                <td>
                                    <span class="badge bg-@GetChapterStatusColor(c.Status)">@c.Status</span>
                                    @if (c.isReported)
                                    {
                                        <span class="badge bg-danger ms-1">@Localizer["Reported"]</span>
                                    }
                                </td>
                                <td>
                                    <a href="@Url.Action("ReadChapter", "Chapter", new { id = c.ChapterID })" class="btn btn-outline-primary btn-sm" target="_blank">@Localizer["View"]</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="text-muted p-3">@Localizer["No Chapters"]</div>
            }
        </div>
    </section>
    <!-- Section 3: Th√¥ng tin t√°c gi·∫£ -->
    <section class="section-card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0">@Localizer["Author Information"]</h5>
            <a href="@Url.Action("ViewUser", "Moderator", new { id = Model.Author.UserID })" class="text-secondary ms-2" title="@Localizer["View User Details"]">
                <i class="bi bi-gear-fill" style="font-size:1.3rem;"></i>
            </a>
        </div>
        <div class="card-body d-flex align-items-center">
            <img src="@(Model.Author.Avatar ?? Url.Content("~/image/default-avatar.png"))" class="rounded-circle me-4" style="width:80px;height:80px;object-fit:cover;border:2px solid #e3e8ee;box-shadow:0 2px 8px rgba(0,0,0,0.07);" alt="@Localizer["Avatar"]" />
            <div>
                <div class="mb-1"><strong>@Localizer["ID:"]</strong> <span class="text-primary">@Model.Author.UserID</span></div>
                <div class="mb-1"><strong>@Localizer["Display Name"]</strong> @Model.Author.DisplayName</div>
                <div class="mb-1"><strong>@Localizer["Email"]</strong> <span class="text-muted">@Model.Author.Email</span></div>
                <div class="mb-1"><strong>@Localizer["Role"]</strong> <span class="badge bg-primary">@Model.Author.Role</span></div>
                <div class="mb-1"><strong>@Localizer["Created At"]</strong> @Model.Author.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                <div class="mb-1"><strong>@Localizer["Status"]</strong> <span class="badge bg-@(Model.Author.Status == PBL3.Models.UserModel.UserStatus.Active ? "success" : "secondary")">@Model.Author.Status</span></div>
            </div>
        </div>
    </section>
</div>
@section Styles {
    <link rel="stylesheet" href="~/css/ViewStory.css" />
}
@section Scripts {
    <script src="~/js/ViewStory.js"></script>
}
@functions {
    private string GetStatusColor(PBL3.Models.StoryModel.StoryStatus status)
    {
        return status switch
        {
            PBL3.Models.StoryModel.StoryStatus.Active => "success",
            PBL3.Models.StoryModel.StoryStatus.Completed => "primary",
            PBL3.Models.StoryModel.StoryStatus.Locked => "danger",
            PBL3.Models.StoryModel.StoryStatus.ReviewPending => "warning text-dark",
            _ => "secondary"
        };
    }
    private string GetChapterStatusColor(PBL3.Models.ChapterStatus status)
    {
        return status switch
        {
            PBL3.Models.ChapterStatus.Active => "success",
            PBL3.Models.ChapterStatus.Locked => "danger",
            _ => "secondary"
        };
    }
}
